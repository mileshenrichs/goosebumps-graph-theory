<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Goosebumps</title>
</head>

<body>
    <style>
        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }
    </style>

    <svg width="1800" height="900"></svg>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <script>

        // create somewhere to put the force directed graph
        const svg = d3.select('svg');
        const width = +svg.attr('width');
        const height = +svg.attr('height');

        d3.json('data.json').then(data => {
            const { nodes, links } = data;

            const simulation = d3.forceSimulation()
                .nodes(nodes);

            simulation
                .force('charge_force', d3.forceManyBody().strength(-25).distanceMax(200))
                .force('center_force', d3.forceCenter(width / 2, height / 2));

            const linkForce = d3.forceLink(links)
                .id(d => d.pageNo)
                .strength(0.5);

            simulation.force('links', linkForce);

            const link = svg.append('g')
                .classed('links', true)
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('stroke-width', 2);

            const node = svg.append('g')
                .classed('nodes', true)
                .selectAll('circle')
                .data(nodes)
                .enter()
                .append('circle')
                .attr('r', 5)
                .attr('fill', page => {
                    if(!page.utility)
                        return 'blue';

                    if(page.utility > 0)
                        return 'green';

                    if(page.utility < 0)
                        return 'red';
                });

            simulation.on('tick', () => {
                node.attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                link.attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
            });

            const dragHandler = d3.drag()
                .on('start', dragStart)
                .on('drag', dragDrag)
                .on('end', dragEnd);

            function dragStart(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragDrag(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragEnd() {
                if (!d3.event.active) simulation.alphaTarget(0);
            }

            dragHandler(node);
            dragHandler(link);
        });
    </script>
</body>